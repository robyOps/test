{% extends "base.html" %}
{% load static %}
{% block title %}Usuarios{% endblock %}

{% block content %}
<section class="page-section">
  <header class="surface-panel">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-4">
        <span class="page-eyebrow">Equipo</span>
        <h1 class="page-title">Usuarios</h1>
        <p class="page-subtitle">Administra cuentas, controla accesos y mantén tu mesa de ayuda funcionando sin fricciones.</p>
      </div>
      <a href="{% url 'accounts:user_create' %}" class="btn btn-primary"><i class="bi bi-person-plus"></i> Nuevo usuario</a>
    </div>
  </header>

  <section class="grid gap-6 lg:grid-cols-[minmax(0,18rem)_1fr]">
    <aside class="space-y-6">
      <article class="surface-panel bg-slate-900/60">
        <h2 class="text-xl font-semibold text-white">Filtros</h2>
        <p class="mt-1 text-sm text-slate-300">Filtra por actividad, grupo o busca por nombre para encontrar rápido a la persona correcta.</p>
        <form method="get" class="mt-4 space-y-4 text-sm">
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400" for="buscar-usuario">Buscar</label>
            <input id="buscar-usuario" name="q" value="{{ filters.q }}" class="input" placeholder="usuario, nombre, email" />
          </div>
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400" for="activo">Activo</label>
            <select id="activo" name="active" class="input">
              <option value="" {% if not filters.active %}selected{% endif %}>(Todos)</option>
              <option value="1" {% if filters.active == "1" %}selected{% endif %}>Sí</option>
              <option value="0" {% if filters.active == "0" %}selected{% endif %}>No</option>
            </select>
          </div>
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400" for="grupo">Grupo</label>
            <select id="grupo" name="group" class="input">
              <option value="" {% if not filters.group %}selected{% endif %}>(Todos)</option>
              {% for g in groups %}
                <option value="{{ g.id }}" {% if filters.group == g.id|stringformat:'s' %}selected{% endif %}>{{ g.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex flex-wrap items-center gap-3 pt-2">
            <button class="btn btn-primary" type="submit"><i class="bi bi-funnel"></i> Filtrar</button>
            <a href="{% url 'accounts:users_list' %}" class="btn btn-ghost"><i class="bi bi-eraser"></i> Limpiar</a>
          </div>
        </form>
      </article>
      <p class="surface-panel bg-slate-900/40 p-4 text-xs text-slate-300">Consejo: documenta los cambios de roles para mantener trazabilidad.</p>
    </aside>

    <div class="space-y-4">
      <article class="surface-panel bg-slate-900/60">
        <div class="flex flex-col gap-3 border-b border-slate-700/40 pb-4 sm:flex-row sm:items-center sm:justify-between">
          <h2 class="text-xl font-semibold text-white">Listado de usuarios</h2>
          <p class="text-xs text-slate-400">Haz clic en editar para actualizar datos o gestionar accesos.</p>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="table text-sm">
            <thead>
              <tr>
                <th scope="col" class="th">Usuario</th>
                <th scope="col" class="th">Nombre</th>
                <th scope="col" class="th">Email</th>
                <th scope="col" class="th">Grupos</th>
                <th scope="col" class="th">Estado</th>
                <th scope="col" class="th">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for u in users %}
              <tr>
                <td class="td font-semibold text-white">{{ u.username }}</td>
                <td class="td text-slate-200">{{ u.first_name }} {{ u.last_name }}</td>
                <td class="td text-slate-300">{{ u.email }}</td>
                <td class="td">
                  <div class="flex flex-wrap gap-2">
                    {% for g in u.groups.all %}
                      <span class="inline-flex items-center gap-2 rounded-full border border-slate-600/40 bg-slate-500/20 px-3 py-1 text-xs font-medium text-slate-200"><i class="bi bi-shield-check text-indigo-200"></i>{{ g.name }}</span>
                    {% empty %}
                      <span class="text-xs text-slate-500">—</span>
                    {% endfor %}
                  </div>
                </td>
                <td class="td">
                  {% if u.is_active %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-emerald-500/15 px-3 py-1 text-xs font-semibold text-emerald-200"><i class="bi bi-check-circle"></i>Activo</span>
                  {% else %}
                    <span class="inline-flex items-center gap-2 rounded-full bg-rose-500/15 px-3 py-1 text-xs font-semibold text-rose-200"><i class="bi bi-x-circle"></i>Inactivo</span>
                  {% endif %}
                </td>
                <td class="td">
                  <div class="flex flex-wrap items-center gap-3 text-xs font-semibold">
                    <a class="text-indigo-200 hover:text-white" href="{% url 'accounts:user_edit' u.id %}"><i class="bi bi-pencil"></i> Editar</a>
                    <a class="text-slate-400 hover:text-rose-300"
                       href="{% url 'accounts:user_toggle' u.id %}"
                       onclick="return confirm('¿Seguro? Cambiarás el estado de este usuario.');">
                      <i class="bi bi-arrow-repeat"></i> {{ u.is_active|yesno:"Desactivar,Activar" }}
                    </a>
                  </div>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td class="td text-center text-sm text-slate-400" colspan="6">Sin resultados por ahora.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </article>
    </div>
  </section>
</section>
{% endblock %}
