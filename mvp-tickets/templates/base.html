{% load static %}
{% load roles notifications %}
<!doctype html>
<html lang="es">
<head>
  <!-- UI-REFRESH-PRO v2 -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Helpdesk{% endblock %}</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HTMX -->
  <script src="https://unpkg.com/htmx.org@2.0.3"></script>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

  <link rel="stylesheet" href="{% static 'ui.css' %}">
  {% block head_extra %}{% endblock %}
</head>
<body class="app-body">
  <a class="skip-link" href="#main-content">Saltar al contenido</a>

  <div class="app-background" aria-hidden="true">
    <div class="app-gradient"></div>
    <div class="app-rings"></div>
    <div class="app-dots"></div>
  </div>

  {% if messages %}
  <div class="toast-wrap" role="status" aria-live="polite">
    {% for message in messages %}
      {% with lvl=message.tags %}
        <div class="toast card {% if 'success' in lvl %}toast-ok{% elif 'warning' in lvl %}toast-warn{% elif 'error' in lvl %}toast-err{% else %}toast-info{% endif %}">{{ message }}</div>
      {% endwith %}
    {% endfor %}
  </div>
  {% endif %}

  <div class="app-shell">
    <header class="app-header">
      <div class="app-header__brand">
        <a href="{% url 'dashboard' %}" class="brand-link" aria-label="Ir al dashboard">
          <span class="brand-mark">Coyahue</span>
          <span class="brand-name">Helpdesk</span>
        </a>
        <p class="brand-tagline">Soporte inteligente con una experiencia visual de clase enterprise.</p>
      </div>

      {% if request.user.is_authenticated %}
      {% with current_path=request.path %}
      <nav class="app-nav" aria-label="Secciones principales">
        <a href="{% url 'dashboard' %}" class="app-nav__link {% if current_path == '/' %}is-active{% endif %}" aria-current="{% if current_path == '/' %}page{% endif %}">
          <i class="bi bi-speedometer2"></i>
          <span>Dashboard</span>
        </a>
        <a href="{% url 'tickets_home' %}" class="app-nav__link {% if current_path|slice:':8' == '/tickets' %}is-active{% endif %}" aria-current="{% if current_path|slice:':8' == '/tickets' %}page{% endif %}">
          <i class="bi bi-life-preserver"></i>
          <span>Tickets</span>
        </a>
        <a href="{% url 'reports_dashboard' %}" class="app-nav__link {% if current_path|slice:':8' == '/reports' %}is-active{% endif %}" aria-current="{% if current_path|slice:':8' == '/reports' %}page{% endif %}">
          <i class="bi bi-bar-chart"></i>
          <span>Reportes</span>
        </a>
        <a href="{% url 'faq_list' %}" class="app-nav__link {% if current_path|slice:':5' == '/faq/' %}is-active{% endif %}" aria-current="{% if current_path|slice:':5' == '/faq/' %}page{% endif %}">
          <i class="bi bi-question-circle"></i>
          <span>FAQ</span>
        </a>
      </nav>
      {% endwith %}
      {% endif %}

      <div class="app-header__actions">
        <button id="theme-toggle" class="btn btn-ghost" type="button" aria-label="Cambiar tema" aria-pressed="false">
          <i class="bi bi-brightness-high" aria-hidden="true"></i>
        </button>

        {% if request.user.is_authenticated %}
          {% if request.user|has_group:"ADMINISTRADOR" or request.user.is_superuser %}
            <details class="app-admin">
              <summary class="app-admin__toggle">
                <i class="bi bi-sliders"></i>
                <span>Admin</span>
                <i class="bi bi-chevron-down"></i>
              </summary>
              <div class="app-admin__panel">
                <a href="{% url 'accounts:users_list' %}"><i class="bi bi-people"></i>Usuarios</a>
                <a href="{% url 'accounts:roles_list' %}"><i class="bi bi-person-gear"></i>Roles</a>
                <a href="{% url 'categories_list' %}"><i class="bi bi-diagram-3"></i>Categorías</a>
                <a href="{% url 'priorities_list' %}"><i class="bi bi-lightning"></i>Prioridades</a>
                <a href="{% url 'areas_list' %}"><i class="bi bi-layers"></i>Áreas</a>
                <a href="{% url 'auto_rules_list' %}"><i class="bi bi-magic"></i>Auto-asignación</a>
                <a href="{% url 'logs_list' %}"><i class="bi bi-clipboard-pulse"></i>Logs</a>
              </div>
            </details>
          {% endif %}

          <a href="{% url 'notifications_list' %}" class="btn btn-icon" aria-label="Ver notificaciones">
            <i class="bi bi-bell"></i>
            {% unread_notifications_count as notif_count %}
            {% if notif_count %}
              <span class="badge">{{ notif_count }}</span>
            {% endif %}
          </a>

          <div class="app-user">
            <span class="app-user__name">Hola, <strong>{{ request.user.username }}</strong></span>
            <form action="{% url 'logout' %}" method="post">
              {% csrf_token %}
              <button type="submit" class="btn btn-ghost">Salir</button>
            </form>
          </div>
        {% else %}
          {% if request.resolver_match.url_name != 'login' %}
          <a href="{% url 'login' %}" class="btn btn-primary">Ingresar</a>
          {% endif %}
        {% endif %}
      </div>
    </header>

    <main id="main-content" class="app-main" tabindex="-1">
      <div class="app-container">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  {% block body_extra %}{% endblock %}
  <script src="{% static 'ui.js' %}"></script>
</body>
</html>
