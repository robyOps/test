{% extends "base.html" %}
{% block title %}Reportes{% endblock %}

{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<section class="page-section">
  <header class="surface-panel">
    <div class="mb-8 flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-4">
        <span class="page-eyebrow">Analítica</span>
        <h1 class="page-title">Reportes y tendencias</h1>
        <p class="page-subtitle">Explora la operación del helpdesk con filtros dinámicos, visualizaciones inmersivas y exporta tus resultados en segundos.</p>
      </div>
      <div class="page-actions">
        <a href="{% url 'reports_export_pdf' %}?from={{ from }}&to={{ to }}&type={{ report_type }}&tech={{ tech_selected }}" class="btn btn-primary"><i class="bi bi-file-earmark-pdf"></i> Exportar PDF</a>
        <a href="{% url 'reports_export_excel' %}?from={{ from }}&to={{ to }}&type={{ report_type }}&tech={{ tech_selected }}" class="btn btn-ghost"><i class="bi bi-file-earmark-spreadsheet"></i> Exportar Excel</a>
      </div>
    </div>
    <form method="get" class="surface-panel surface-panel--contrast">
      <div class="grid gap-4 text-sm md:grid-cols-5">
        <div class="flex flex-col gap-2">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-soft">Desde</label>
          <input type="date" name="from" value="{{ from }}" class="input" />
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-soft">Hasta</label>
          <input type="date" name="to" value="{{ to }}" class="input" />
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-soft">Tipo de reporte</label>
          <select name="type" class="input">
            <option value="total" {% if report_type == 'total' %}selected{% endif %}>Total</option>
            <option value="categoria" {% if report_type == 'categoria' %}selected{% endif %}>Por categoría</option>
            <option value="promedio" {% if report_type == 'promedio' %}selected{% endif %}>Tiempo promedio</option>
            <option value="tecnico" {% if report_type == 'tecnico' %}selected{% endif %}>Por técnico</option>
            <option value="urgencia" {% if report_type == 'urgencia' %}selected{% endif %}>Urgencia</option>
          </select>
        </div>
        <div class="flex flex-col gap-2">
          <label class="text-xs font-semibold uppercase tracking-[0.2em] text-muted-soft">Técnico</label>
          <select name="tech" class="input">
            <option value="" {% if not tech_selected %}selected{% endif %}>(Todos)</option>
            {% for t in techs %}
            <option value="{{ t.id }}" {% if tech_selected == t.id|stringformat:'s' %}selected{% endif %}>{{ t.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex items-end gap-2">
          <button class="btn btn-primary w-full" type="submit"><i class="bi bi-funnel"></i> Filtrar</button>
          <a href="{% url 'reports_dashboard' %}" class="btn btn-ghost"><i class="bi bi-eraser"></i> Limpiar</a>
        </div>
      </div>
    </form>
  </header>

  <section class="grid gap-5 md:grid-cols-3">
    <article class="stat-card">
      <span class="stat-card__label">Tickets totales</span>
      <span class="stat-card__value">{{ total }}</span>
      <div class="space-y-1 text-sm text-muted">
        {% for k,v in by_status.items %}
        <div class="flex items-center justify-between">
          <span>{{ k }}</span>
          <span class="font-semibold text-contrast">{{ v }}</span>
        </div>
        {% endfor %}
      </div>
    </article>
    <article class="stat-card">
      <span class="stat-card__label">Promedio de resolución (hrs)</span>
      <span class="stat-card__value">{{ avg_hours|default:"—" }}</span>
      <p class="text-sm text-muted">Tiempo medio desde la apertura hasta la resolución de tickets cerrados.</p>
    </article>
    <article class="stat-card">
      <span class="stat-card__label">Tickets por prioridad</span>
      <ul class="space-y-1 text-sm text-muted">
        {% for row in by_priority %}
        <li class="flex items-center justify-between">
          <span>{{ row.priority__name }}</span>
          <span class="font-semibold text-contrast">{{ row.count }}</span>
        </li>
        {% endfor %}
      </ul>
    </article>
  </section>

  <section class="grid gap-6 lg:grid-cols-2">
    <article class="surface-panel surface-panel--muted">
      <h2 class="heading-md text-contrast">Por categoría</h2>
      <p class="text-sm text-muted">Volumen de tickets según clasificación funcional.</p>
      <div class="mt-4 h-64"><canvas id="chartCat"></canvas></div>
    </article>
    <article class="surface-panel surface-panel--muted">
      <h2 class="heading-md text-contrast">Por prioridad</h2>
      <p class="text-sm text-muted">Distribución según la urgencia declarada.</p>
      <div class="mt-4 h-64"><canvas id="chartPri"></canvas></div>
    </article>
    <article class="surface-panel surface-panel--muted">
      <h2 class="heading-md text-contrast">Por técnico</h2>
      <p class="text-sm text-muted">Tickets asignados por responsable.</p>
      <div class="mt-4 h-64"><canvas id="chartTech"></canvas></div>
    </article>
    <article class="surface-panel surface-panel--muted">
      <h2 class="heading-md text-contrast">Horas de resolución</h2>
      <p class="text-sm text-muted">Histograma de tiempos empleados en resolver incidencias.</p>
      <div class="mt-4 h-64"><canvas id="chartHist"></canvas></div>
    </article>
    <article class="surface-panel surface-panel--muted lg:col-span-2">
      <h2 class="heading-md text-contrast">Categorías más lentas</h2>
      <p class="text-sm text-muted">Promedio de horas hasta el cierre por categoría.</p>
      <div class="mt-4 h-64"><canvas id="chartCatSlow"></canvas></div>
    </article>
  </section>
</section>
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  {{ chart_cat|json_script:"chart_cat_data" }}
  {{ chart_pri|json_script:"chart_pri_data" }}
  {{ chart_tech|json_script:"chart_tech_data" }}
  {{ chart_hist|json_script:"chart_hist_data" }}
  {{ chart_cat_slow|json_script:"chart_cat_slow_data" }}
  <script>
    const css = () => getComputedStyle(document.documentElement);
    const color = (token, alpha = 1) => {
      const name = token.startsWith('--') ? token : `--${token}`;
      const value = css().getPropertyValue(name).trim();
      if (!value) {
        return alpha === 1 ? 'rgba(148, 163, 184, 1)' : `rgba(148, 163, 184, ${alpha})`;
      }
      return alpha === 1 ? `rgb(${value})` : `rgba(${value}, ${alpha})`;
    };

    const PALETTE_TOKENS = ['--accent', '--accent-strong', '--success', '--warning', '--danger', '--info', '--surface-contrast'];
    const colorFor = (index, alpha = 1) => color(PALETTE_TOKENS[index % PALETTE_TOKENS.length], alpha);

    function parseData(id) {
      const el = document.getElementById(id);
      if (!el) return { labels: [], data: [] };
      const js = JSON.parse(el.textContent || "{}");
      const labels = Array.isArray(js.labels) ? js.labels : [];
      const data = (Array.isArray(js.data) ? js.data : []).map((value) => Number(value) || 0);
      return { labels, data };
    }

    function buildBar(canvasId, dataset, title, { decimals = 0 } = {}) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return null;
      const ctx = canvas.getContext("2d");
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, color('--accent-strong', 0.9));
      gradient.addColorStop(1, color('--accent', 0.35));

      return new Chart(ctx, {
        type: "bar",
        data: {
          labels: dataset.labels,
          datasets: [
            {
              label: title,
              data: dataset.data,
              backgroundColor: dataset.data.map((_, index) => colorFor(index, 0.85)),
              borderColor: dataset.data.map((_, index) => colorFor(index, 0.95)),
              borderWidth: 1,
              borderRadius: 16,
              borderSkipped: false,
              hoverBackgroundColor: gradient,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: color('--surface', 0.94),
              titleColor: color('--text'),
              bodyColor: color('--text-soft'),
              borderColor: color('--border', 0.4),
              borderWidth: 1,
              cornerRadius: 14,
              padding: 12,
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { precision: decimals, color: color('--text-muted', 0.75) },
              grid: { color: color('--border', 0.35) },
            },
            x: {
              ticks: { color: color('--text-muted', 0.75) },
              grid: { display: false },
            },
          },
        },
      });
    }

    const cat = parseData("chart_cat_data");
    const pri = parseData("chart_pri_data");
    const tech = parseData("chart_tech_data");
    const hist = parseData("chart_hist_data");
    const slow = parseData("chart_cat_slow_data");

    const charts = [
      buildBar("chartCat", cat, "Por categoría"),
      buildBar("chartPri", pri, "Por prioridad"),
      buildBar("chartTech", tech, "Por técnico"),
      buildBar("chartHist", hist, "Horas de resolución (histograma)", { decimals: 1 }),
      buildBar("chartCatSlow", slow, "Categorías más lentas", { decimals: 1 })
    ].filter(Boolean);

    const refreshCharts = () => {
      charts.forEach((chart) => {
        const dataset = chart.data.datasets[0];
        dataset.backgroundColor = dataset.data.map((_, index) => colorFor(index, 0.85));
        dataset.borderColor = dataset.data.map((_, index) => colorFor(index, 0.95));
        const gradient = chart.ctx.createLinearGradient(0, 0, 0, chart.canvas.height);
        gradient.addColorStop(0, color('--accent-strong', 0.9));
        gradient.addColorStop(1, color('--accent', 0.35));
        dataset.hoverBackgroundColor = gradient;

        const tooltip = chart.options.plugins.tooltip;
        tooltip.backgroundColor = color('--surface', 0.94);
        tooltip.titleColor = color('--text');
        tooltip.bodyColor = color('--text-soft');
        tooltip.borderColor = color('--border', 0.4);

        if (chart.options.scales?.y) {
          chart.options.scales.y.ticks.color = color('--text-muted', 0.75);
          chart.options.scales.y.grid.color = color('--border', 0.35);
        }
        if (chart.options.scales?.x) {
          chart.options.scales.x.ticks.color = color('--text-muted', 0.75);
        }

        chart.update('none');
      });
    };

    refreshCharts();
    document.addEventListener('themechange', refreshCharts);
  </script>
{% endblock %}
