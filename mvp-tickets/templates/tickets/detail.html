{% extends "base.html" %}
{% block title %}{{ t.code }}{% endblock %}

{% block content %}
{# Vista detallada del ticket con un tono cercano y compatible con el resto del sitio. #}
<section class="space-y-8">
  <article class="rounded-3xl border border-indigo-100 bg-gradient-to-br from-indigo-600 via-indigo-500 to-purple-500 p-8 text-white shadow">
    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-3">
        <div class="inline-flex items-center gap-2 rounded-full bg-white/20 px-3 py-1 text-xs font-semibold uppercase tracking-[0.4em]">Ticket {{ t.code }}</div>
        <h1 class="text-3xl font-bold leading-tight">{{ t.title }}</h1>
        <p class="max-w-2xl text-sm text-indigo-100">Mantén la trazabilidad del caso: acá queda todo el detalle, la conversación con el equipo y los cambios de estado.</p>
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <span class="inline-flex items-center gap-2 rounded-full bg-white/20 px-3 py-1 font-semibold">
            <i class="bi bi-person-circle"></i>
            Solicitante: {{ t.requester.username }}
          </span>
          <span class="inline-flex items-center gap-2 rounded-full bg-white/20 px-3 py-1 font-semibold">
            <i class="bi bi-circle-half"></i>
            Estado: {{ t.get_status_display }}
          </span>
          <span class="inline-flex items-center gap-2 rounded-full bg-white/20 px-3 py-1 font-semibold">
            <i class="bi bi-lightning-charge"></i>
            Prioridad: {{ t.priority.name }}
          </span>
        </div>
      </div>
      <div class="flex flex-col items-start gap-3 sm:flex-row sm:items-center">
        <a href="{% url 'tickets_home' %}" class="btn inline-flex items-center gap-2 rounded-full bg-white/20 px-4 py-2 text-sm font-semibold text-white backdrop-blur transition hover:bg-white/30">
          <i class="bi bi-arrow-left"></i> Volver a tickets
        </a>
        <a href="{% url 'ticket_print' t.id %}" target="_blank" class="btn inline-flex items-center gap-2 rounded-full bg-white px-4 py-2 text-sm font-semibold text-indigo-700 shadow-lg shadow-indigo-900/20 hover:bg-indigo-50">
          <i class="bi bi-printer"></i> Imprimir
        </a>
        <a href="{% url 'ticket_pdf' t.id %}" class="btn inline-flex items-center gap-2 rounded-full bg-white px-4 py-2 text-sm font-semibold text-indigo-700 shadow-lg shadow-indigo-900/20 hover:bg-indigo-50">
          <i class="bi bi-filetype-pdf"></i> Descargar PDF
        </a>
        {% if request.user.is_staff %}
        <a href="{% url 'logs_list' %}?model=ticket&obj_id={{ t.id }}" class="btn inline-flex items-center gap-2 rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-black">
          <i class="bi bi-search"></i> Auditoría
        </a>
        {% endif %}
      </div>
    </div>
    {% if t.is_overdue or t.is_warning or t.is_critical %}
    <div class="mt-6 flex flex-wrap items-center gap-3 text-sm">
      {% if t.is_overdue %}
        <span class="inline-flex items-center gap-2 rounded-full bg-rose-100 px-3 py-1 font-semibold text-rose-700"><i class="bi bi-alarm"></i> SLA vencido · venció {{ t.due_at }}</span>
      {% elif t.is_warning %}
        <span class="inline-flex items-center gap-2 rounded-full bg-amber-100 px-3 py-1 font-semibold text-amber-700"><i class="bi bi-hourglass-split"></i> SLA por vencer · {{ t.remaining_hours|floatformat:0 }}h restantes</span>
      {% endif %}
      {% if t.is_critical %}
        <span class="inline-flex items-center gap-2 rounded-full bg-rose-600 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-white"><i class="bi bi-lightning"></i> Crítico</span>
      {% endif %}
    </div>
    {% endif %}
  </article>

  <section class="grid gap-6 lg:grid-cols-[1.1fr_0.9fr]">
    <article class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
      <h2 class="text-lg font-semibold text-slate-900">Ficha del ticket</h2>
      <dl class="mt-4 grid grid-cols-1 gap-4 text-sm text-slate-600 md:grid-cols-2">
        <div class="space-y-1">
          <dt class="text-xs font-semibold uppercase text-slate-500">Estado actual</dt>
          <dd>
            <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold {% if t.status == 'OPEN' %}bg-sky-100 text-sky-700{% elif t.status == 'IN_PROGRESS' %}bg-amber-100 text-amber-700{% elif t.status == 'RESOLVED' %}bg-emerald-100 text-emerald-700{% else %}bg-slate-100 text-slate-600{% endif %}">
              <i class="bi bi-circle-fill text-[8px]"></i>{{ t.get_status_display }}
            </span>
          </dd>
        </div>
        <div class="space-y-1">
          <dt class="text-xs font-semibold uppercase text-slate-500">Tipo</dt>
          <dd class="inline-flex items-center gap-2">
            {{ t.get_kind_display }}
            {% if t.kind == 'INCIDENT' %}
              <i class="bi bi-exclamation-triangle-fill text-rose-500" title="Incidente: interrupción o degradación del servicio."></i>
            {% elif t.kind == 'REQUEST' %}
              <i class="bi bi-clipboard-check text-emerald-600" title="Solicitud: requerimiento o petición de servicio."></i>
            {% else %}
              <i class="bi bi-info-circle text-gray-500" title="Clasificación del ticket"></i>
            {% endif %}
          </dd>
        </div>
        <div class="space-y-1">
          <dt class="text-xs font-semibold uppercase text-slate-500">Categoría</dt>
          <dd>{{ t.category.name }}</dd>
        </div>
        <div class="space-y-1">
          <dt class="text-xs font-semibold uppercase text-slate-500">Área vinculada</dt>
          <dd>{% if t.area %}{{ t.area.name }}{% else %}<span class="text-slate-400">Sin definir</span>{% endif %}</dd>
        </div>
        <div class="space-y-1">
          <dt class="text-xs font-semibold uppercase text-slate-500">Asignado a</dt>
          <dd>{% if t.assigned_to %}{{ t.assigned_to.username }}{% else %}<span class="text-slate-400">Aún sin asignar</span>{% endif %}</dd>
        </div>
        <div class="space-y-1">
          <dt class="text-xs font-semibold uppercase text-slate-500">Tiempos clave</dt>
          <dd class="space-y-1 text-xs">
            <div>Creado: {{ t.created_at }}</div>
            {% if t.resolved_at %}<div>Resuelto: {{ t.resolved_at }}</div>{% endif %}
            {% if t.closed_at %}<div>Cerrado: {{ t.closed_at }}</div>{% endif %}
          </dd>
        </div>
      </dl>
      <div class="mt-6 space-y-3 rounded-2xl bg-slate-50 p-5 text-sm text-slate-600">
        <div class="font-semibold text-slate-800">Seguimiento SLA</div>
        {% if t.is_overdue %}
          <p class="text-rose-600">Este ticket venció el {{ t.due_at }}. Gestiona la regularización y avisa al solicitante.</p>
        {% else %}
          <p>El SLA vence el {{ t.due_at }}. Restan aproximadamente {{ t.remaining_hours|floatformat:0 }} horas.</p>
        {% endif %}
      </div>
      <section class="mt-6 space-y-3">
        <h3 class="text-lg font-semibold text-slate-900">Descripción</h3>
        <p class="rounded-2xl border border-slate-200 bg-white px-5 py-4 text-sm leading-relaxed text-slate-700 whitespace-pre-line">{{ t.description }}</p>
      </section>
    </article>

    <article class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm space-y-6">
      {% if can_assign %}
      <section class="space-y-3">
        <h2 class="text-lg font-semibold text-slate-900">Asignación</h2>
        <form method="post" action="{% url 'ticket_assign' t.id %}" class="space-y-4 text-sm text-slate-600">
          {% csrf_token %}
          {% if is_admin_u %}
            <div class="space-y-1">
              <label class="text-xs font-semibold uppercase text-slate-500" for="asignacion">Asignar a</label>
              <select id="asignacion" name="to_user_id" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100">
                {% for u in tech_users %}
                  <option value="{{ u.id }}" {% if t.assigned_to_id == u.id %}selected{% endif %}>{{ u.username }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="space-y-1">
              <label class="text-xs font-semibold uppercase text-slate-500" for="motivo">Motivo (opcional)</label>
              <input id="motivo" type="text" name="reason" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100" placeholder="Reasignación" />
            </div>
            <button class="btn inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-700" type="submit">
              <i class="bi bi-person-check"></i> Asignar
            </button>
          {% elif is_tech_u %}
            {% if t.assigned_to_id == request.user.id %}
              <p class="rounded-xl bg-slate-50 px-4 py-3 text-xs text-slate-500">Este ticket ya está asignado a ti.</p>
            {% else %}
              <input type="hidden" name="to_user_id" value="{{ request.user.id }}">
              <div class="space-y-1">
                <label class="text-xs font-semibold uppercase text-slate-500" for="nuevo_titulo">Nuevo título (opcional)</label>
                <input id="nuevo_titulo" type="text" name="new_title" value="{{ t.title }}" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100" placeholder="Define un título más descriptivo" />
              </div>
              <div class="space-y-1">
                <label class="text-xs font-semibold uppercase text-slate-500" for="motivo_tech">Motivo (opcional)</label>
                <input id="motivo_tech" type="text" name="reason" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100" placeholder="Auto-asignación" />
              </div>
              <button class="btn inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-700" type="submit">
                <i class="bi bi-emoji-sunglasses"></i> Auto-asignarme
              </button>
            {% endif %}
          {% endif %}
        </form>
      </section>
      {% endif %}

      {% if allowed_transitions %}
      <section class="space-y-3">
        <h2 class="text-lg font-semibold text-slate-900">Cambiar estado</h2>
        <form method="post" action="{% url 'ticket_transition' t.id %}" class="space-y-4 text-sm text-slate-600">
          {% csrf_token %}
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-500" for="nuevo_estado">Nuevo estado</label>
            <select id="nuevo_estado" name="next_status" class="w-full rounded-xl border border-slate-200 px-3 py-2 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-100" required>
              {% for key, label in allowed_transitions %}
                <option value="{{ key }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="space-y-1">
            <label class="text-xs font-semibold uppercase text-slate-500" for="comentario_estado">Comentario (opcional)</label>
            <textarea id="comentario_estado" name="comment" rows="3" class="w-full rounded-2xl border border-slate-200 px-4 py-3 focus:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-100" placeholder="Cuéntale al equipo qué cambió"></textarea>
          </div>
          <label class="inline-flex items-center gap-2 text-xs font-semibold uppercase text-slate-500">
            <input type="checkbox" name="is_internal" class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"> Interno
          </label>
          <button class="btn inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 font-semibold text-white shadow hover:bg-emerald-600" type="submit">
            <i class="bi bi-arrow-repeat"></i> Actualizar estado
          </button>
        </form>
      </section>
      {% endif %}
    </article>
  </section>

  <section class="grid gap-6 lg:grid-cols-[1.2fr_0.8fr]">
    <article class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm space-y-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-900">Conversación</h2>
        <span class="text-xs text-slate-400">Todo queda registrado para el equipo.</span>
      </div>
      <div id="discussion"
           hx-get="{% url 'discussion_partial' t.id %}"
           hx-trigger="load, revealed"
           hx-target="#discussion"
           hx-swap="innerHTML">
        <div class="text-sm text-slate-500">Cargando comentarios…</div>
      </div>

      <form class="space-y-4 rounded-2xl border border-slate-200 bg-slate-50/60 p-5" method="post" enctype="multipart/form-data"
            hx-post="{% url 'add_comment' t.id %}"
            hx-target="#discussion" hx-swap="innerHTML" hx-encoding="multipart/form-data">
        {% csrf_token %}
        <div class="space-y-2">
          <label class="text-sm font-semibold text-slate-700" for="comentario">Nuevo comentario</label>
          <textarea id="comentario" name="body" class="w-full rounded-2xl border border-slate-200 px-4 py-3 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100" rows="3" placeholder="Describe la actualización" required></textarea>
        </div>
        {% if can_mark_internal %}
        <label class="inline-flex items-center gap-2 text-xs font-semibold uppercase text-slate-500">
          <input type="checkbox" name="is_internal" class="h-4 w-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"> Interno
        </label>
        {% endif %}
        {% if can_upload_files %}
        <div class="space-y-2 text-sm">
          <label class="font-semibold text-slate-700" for="archivo">Adjuntar archivo (opcional)</label>
          <input id="archivo" type="file" name="file" class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm focus:border-indigo-400 focus:outline-none focus:ring-2 focus:ring-indigo-100">
          <p class="text-xs text-slate-500">Sube capturas o respaldos para que el equipo entienda el panorama completo.</p>
        </div>
        {% endif %}
        <button class="btn inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-700" type="submit">
          <i class="bi bi-chat-text"></i> Guardar comentario
        </button>
      </form>
    </article>

    <article class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-900">Historial general</h2>
        <span class="text-xs text-slate-400">Auditoría paso a paso</span>
      </div>
      <div class="mt-4" id="audit"
           hx-get="{% url 'audit_partial' t.id %}"
           hx-trigger="load, revealed"
           hx-target="#audit"
           hx-swap="innerHTML">
        <div class="text-sm text-slate-500">Cargando historial…</div>
      </div>
    </article>
  </section>
</section>
{% endblock %}
