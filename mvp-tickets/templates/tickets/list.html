{% extends "base.html" %}
{% block title %}Mis tickets{% endblock %}

{% block content %}
<section class="page-section">
  <header class="surface-panel">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="stack-lg">
        <span class="page-eyebrow">Tickets</span>
        <h1 class="page-title">Tu bandeja de solicitudes</h1>
        <p class="page-subtitle">Gestiona cada caso con claridad. Prioriza lo crítico, filtra por estado y coordina a tu equipo con una vista ultra nítida.</p>
      </div>
      <div class="page-actions">
        <a href="{% url 'ticket_create' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Levantar ticket</a>
      </div>
    </div>
  </header>

  {% if tech_counters %}
  <section class="stat-grid">
    <article class="stat-card">
      <div class="flex items-center justify-between"><span class="stat-card__label">Asignados a ti</span><span class="stat-card__icon"><i class="bi bi-person-workspace"></i></span></div>
      <p class="stat-card__value">{{ tech_counters.assigned }}</p>
      <p class="text-xs text-muted-soft">Casos que dependen directamente de ti.</p>
    </article>
    <article class="stat-card">
      <div class="flex items-center justify-between"><span class="stat-card__label">Tickets activos</span><span class="stat-card__icon"><i class="bi bi-activity"></i></span></div>
      <p class="stat-card__value">{{ tech_counters.total }}</p>
      <p class="text-xs text-muted-soft">Todo lo que está en movimiento hoy.</p>
    </article>
    <article class="stat-card">
      <div class="flex items-center justify-between"><span class="stat-card__label">Por asignar</span><span class="stat-card__icon"><i class="bi bi-hourglass-split"></i></span></div>
      <p class="stat-card__value">{{ tech_counters.unassigned }}</p>
      <p class="text-xs text-muted-soft">Toma los pendientes para que nadie se quede sin atención.</p>
    </article>
  </section>
  {% endif %}

  {% if inbox_links %}
  <section class="surface-panel surface-panel--muted">
    <h2 class="page-eyebrow">Bandejas rápidas</h2>
    <div class="flex flex-wrap items-center gap-2">
      {% for option in inbox_links %}
        <a href="{{ option.url }}" class="pill {% if current_inbox == option.value %}pill--accent{% else %}pill--muted{% endif %}"><i class="bi bi-inbox"></i>{{ option.label }}</a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section class="grid gap-6 lg:grid-cols-[minmax(0,18rem)_1fr]">
    <aside class="space-y-6">
      <article class="surface-panel surface-panel--muted">
        <header class="stack">
          <h2 class="heading-md">Filtros</h2>
          <p class="text-xs text-muted-soft">Afinemos la búsqueda para encontrar rápido el ticket que necesitas.</p>
        </header>
        <form method="get" class="stack text-sm">
          <div class="stack">
            <label class="text-xs text-muted-soft uppercase tracking-[0.2em]" for="buscar">Buscar</label>
            <input id="buscar" name="q" value="{{ filters.q }}" class="input" placeholder="Código, título o descripción" />
          </div>
          <div class="stack">
            <label class="text-xs text-muted-soft uppercase tracking-[0.2em]" for="estado">Estado</label>
            <select id="estado" name="status" class="input">
              <option value="" {% if not filters.status %}selected{% endif %}>(Todos)</option>
              {% for key, label in statuses %}
                <option value="{{ key }}" {% if filters.status == key %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="stack">
            <label class="text-xs text-muted-soft uppercase tracking-[0.2em]" for="categoria">Categoría (ID)</label>
            <input id="categoria" name="category" value="{{ filters.category }}" class="input" placeholder="Ej: 1" />
          </div>
          <div class="stack">
            <label class="text-xs text-muted-soft uppercase tracking-[0.2em]" for="prioridad">Prioridad</label>
            <select id="prioridad" name="priority" class="input">
              <option value="" {% if not filters.priority %}selected{% endif %}>(Todas)</option>
              {% for p in priorities %}
                <option value="{{ p.id }}" {% if filters.priority|stringformat:'s' == p.id|stringformat:'s' %}selected{% endif %}>{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex items-center justify-between gap-3">
            <label class="inline-flex items-center gap-2 text-xs text-muted-soft uppercase tracking-[0.2em]">
              <input type="checkbox" name="alerts" value="1" {% if filters.alerts %}checked{% endif %}>
              Alertas SLA
            </label>
            <label class="inline-flex items-center gap-2 text-xs text-muted-soft uppercase tracking-[0.2em]">
              <input type="checkbox" name="hide_closed" value="1" {% if filters.hide_closed == '1' %}checked{% endif %}>
              Ocultar cerrados
            </label>
          </div>
          <div class="stack">
            <label class="text-xs text-muted-soft uppercase tracking-[0.2em]" for="pagina">Por página</label>
            <input id="pagina" name="page_size" value="{{ page_size }}" class="input w-24" />
          </div>
          <div class="flex flex-wrap items-center gap-3">
            <button class="btn btn-primary" type="submit"><i class="bi bi-funnel"></i> Aplicar</button>
            <a href="{% url 'tickets_home' %}" class="btn btn-ghost"><i class="bi bi-eraser"></i> Limpiar</a>
          </div>
        </form>
      </article>
      <p class="surface-note">Consejo: registra cada actualización para que todo el equipo mantenga contexto.</p>
    </aside>

    <div class="space-y-6">
      <article class="surface-panel surface-panel--muted">
        <div class="panel-header flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <h2 class="heading-md">Listado de tickets</h2>
          <p class="text-xs text-muted-soft">Ordena por columna para ver lo más urgente primero.</p>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="table text-sm">
            <thead>
              <tr>
                <th scope="col" class="th">Código
                  <a href="?sort=code{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-code{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Título
                  <a href="?sort=title{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-title{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Estado
                  <a href="?sort=status{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-status{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Tipo
                  <a href="?sort=kind{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-kind{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Categoría
                  <a href="?sort=category__name{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-category__name{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Prioridad
                  <a href="?sort=priority__name{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-priority__name{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Asignado
                  <a href="?sort=assigned_to__username{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-assigned_to__username{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">SLA</th>
                <th scope="col" class="th">Creado
                  <a href="?sort=created_at{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-created_at{{ qs_no_sort }}" class="ml-1 text-muted-soft"><i class="bi bi-arrow-down"></i></a>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for t in tickets %}
              <tr class="ticket-row {% if t.is_overdue %}ticket-row--danger{% elif t.is_warning %}ticket-row--warning{% endif %}"
                data-ticket-row data-href="{% url 'ticket_detail' t.id %}" tabindex="0" role="link" aria-label="Abrir ticket {{ t.code }}">
                <td class="td font-semibold">
                  <a class="pill pill--accent" href="{% url 'ticket_detail' t.id %}">
                    <i class="bi bi-hash"></i>{{ t.code }}
                  </a>
                </td>
                <td class="td">{{ t.title }}</td>
                <td class="td">
                  <span class="status-badge {% if t.status == 'OPEN' %}status-badge--open{% elif t.status == 'IN_PROGRESS' %}status-badge--progress{% elif t.status == 'RESOLVED' %}status-badge--resolved{% else %}status-badge--closed{% endif %}">
                    <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i>{{ t.get_status_display }}
                  </span>
                </td>
                <td class="td">
                  <span class="inline-flex items-center gap-1 text-muted">
                    {{ t.get_kind_display }}
                    {% if t.kind == 'INCIDENT' %}<i class="bi bi-lightning-charge-fill text-amber-200"></i>{% endif %}
                  </span>
                </td>
                <td class="td text-muted">{{ t.category.name|default:"—" }}</td>
                <td class="td text-muted">{{ t.priority.name|default:"—" }}</td>
                <td class="td text-muted">{% if t.assigned_to %}{{ t.assigned_to.username }}{% else %}—{% endif %}</td>
                <td class="td">
                  {% if t.remaining_hours %}
                  <span class="sla-pill"><i class="bi bi-hourglass-split"></i>{{ t.remaining_hours|floatformat:1 }} h</span>
                  {% else %}
                  <span class="text-xs text-muted-soft">—</span>
                  {% endif %}
                </td>
                <td class="td text-muted-soft">{{ t.created_at|date:'d/m/Y H:i' }}</td>
              </tr>
              {% empty %}
              <tr>
                <td class="td empty-table-row" colspan="9">Sin resultados en este momento.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </article>
    </div>
  </section>
</section>
{% endblock %}
