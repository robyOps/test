{% extends "base.html" %}
{% block title %}Mis tickets{% endblock %}

{% block content %}
<section class="page-section">
  <header class="surface-panel">
    <div class="flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-4">
        <span class="page-eyebrow">Tickets</span>
        <h1 class="page-title">Tu bandeja de solicitudes</h1>
        <p class="page-subtitle">Gestiona cada caso con claridad. Prioriza lo crítico, filtra por estado y coordina a tu equipo con una vista ultra nítida.</p>
      </div>
      <div class="page-actions">
        <a href="{% url 'ticket_create' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Levantar ticket</a>
      </div>
    </div>
  </header>

  {% if tech_counters %}
  <section class="stat-grid">
    <article class="stat-card">
      <div class="flex items-center justify-between"><span class="stat-card__label">Asignados a ti</span><span class="stat-card__icon"><i class="bi bi-person-workspace"></i></span></div>
      <p class="stat-card__value">{{ tech_counters.assigned }}</p>
      <p class="text-xs text-slate-200/80">Casos que dependen directamente de ti.</p>
    </article>
    <article class="stat-card">
      <div class="flex items-center justify-between"><span class="stat-card__label">Tickets activos</span><span class="stat-card__icon"><i class="bi bi-activity"></i></span></div>
      <p class="stat-card__value">{{ tech_counters.total }}</p>
      <p class="text-xs text-slate-200/80">Todo lo que está en movimiento hoy.</p>
    </article>
    <article class="stat-card">
      <div class="flex items-center justify-between"><span class="stat-card__label">Por asignar</span><span class="stat-card__icon"><i class="bi bi-hourglass-split"></i></span></div>
      <p class="stat-card__value">{{ tech_counters.unassigned }}</p>
      <p class="text-xs text-slate-200/80">Toma los pendientes para que nadie se quede sin atención.</p>
    </article>
  </section>
  {% endif %}

  {% if inbox_links %}
  <section class="surface-panel bg-slate-900/60">
    <h2 class="text-sm font-semibold uppercase tracking-[0.3em] text-slate-300 mb-3">Bandejas rápidas</h2>
    <div class="flex flex-wrap items-center gap-2">
      {% for option in inbox_links %}
        <a href="{{ option.url }}" class="inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-medium transition {% if current_inbox == option.value %}border-indigo-400 bg-indigo-500/20 text-white{% else %}border-slate-600/40 text-slate-300 hover:border-indigo-300 hover:text-white{% endif %}"><i class="bi bi-inbox"></i>{{ option.label }}</a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section class="grid gap-6 lg:grid-cols-[minmax(0,18rem)_1fr]">
    <aside class="space-y-6">
      <article class="surface-panel bg-slate-900/60 space-y-4">
        <header class="space-y-1">
          <h2 class="text-lg font-semibold text-white">Filtros</h2>
          <p class="text-xs text-slate-300">Afinemos la búsqueda para encontrar rápido el ticket que necesitas.</p>
        </header>
        <form method="get" class="space-y-4 text-sm">
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400" for="buscar">Buscar</label>
            <input id="buscar" name="q" value="{{ filters.q }}" class="input" placeholder="Código, título o descripción" />
          </div>
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400" for="estado">Estado</label>
            <select id="estado" name="status" class="input">
              <option value="" {% if not filters.status %}selected{% endif %}>(Todos)</option>
              {% for key, label in statuses %}
                <option value="{{ key }}" {% if filters.status == key %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400" for="categoria">Categoría (ID)</label>
            <input id="categoria" name="category" value="{{ filters.category }}" class="input" placeholder="Ej: 1" />
          </div>
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400" for="prioridad">Prioridad</label>
            <select id="prioridad" name="priority" class="input">
              <option value="" {% if not filters.priority %}selected{% endif %}>(Todas)</option>
              {% for p in priorities %}
                <option value="{{ p.id }}" {% if filters.priority|stringformat:'s' == p.id|stringformat:'s' %}selected{% endif %}>{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="flex items-center justify-between gap-3">
            <label class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">
              <input type="checkbox" name="alerts" value="1" class="h-4 w-4 rounded border-slate-500 bg-slate-700 text-indigo-400 focus:ring-indigo-500" {% if filters.alerts %}checked{% endif %}>
              Alertas SLA
            </label>
            <label class="inline-flex items-center gap-2 text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">
              <input type="checkbox" name="hide_closed" value="1" class="h-4 w-4 rounded border-slate-500 bg-slate-700 text-indigo-400 focus:ring-indigo-500" {% if filters.hide_closed == '1' %}checked{% endif %}>
              Ocultar cerrados
            </label>
          </div>
          <div class="space-y-2">
            <label class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400" for="pagina">Por página</label>
            <input id="pagina" name="page_size" value="{{ page_size }}" class="input w-24" />
          </div>
          <div class="flex flex-wrap items-center gap-3">
            <button class="btn btn-primary" type="submit"><i class="bi bi-funnel"></i> Aplicar</button>
            <a href="{% url 'tickets_home' %}" class="btn btn-ghost"><i class="bi bi-eraser"></i> Limpiar</a>
          </div>
        </form>
      </article>
      <p class="surface-panel bg-slate-900/40 p-4 text-xs text-slate-300">Consejo: registra cada actualización para que todo el equipo mantenga contexto.</p>
    </aside>

    <div class="space-y-6">
      <article class="surface-panel bg-slate-900/60">
        <div class="flex flex-col gap-3 border-b border-slate-700/40 pb-4 sm:flex-row sm:items-center sm:justify-between">
          <h2 class="text-lg font-semibold text-white">Listado de tickets</h2>
          <p class="text-xs text-slate-400">Ordena por columna para ver lo más urgente primero.</p>
        </div>
        <div class="mt-4 overflow-x-auto">
          <table class="table text-sm">
            <thead>
              <tr>
                <th scope="col" class="th">Código
                  <a href="?sort=code{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-code{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Título
                  <a href="?sort=title{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-title{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Estado
                  <a href="?sort=status{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-status{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Tipo
                  <a href="?sort=kind{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-kind{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Categoría
                  <a href="?sort=category__name{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-category__name{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Prioridad
                  <a href="?sort=priority__name{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-priority__name{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">Asignado
                  <a href="?sort=assigned_to__username{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-assigned_to__username{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-down"></i></a>
                </th>
                <th scope="col" class="th">SLA</th>
                <th scope="col" class="th">Creado
                  <a href="?sort=created_at{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-up"></i></a>
                  <a href="?sort=-created_at{{ qs_no_sort }}" class="ml-1 text-slate-400 hover:text-white"><i class="bi bi-arrow-down"></i></a>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for t in tickets %}
              <tr class="cursor-pointer transition hover:bg-indigo-500/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-0 focus-visible:outline-indigo-400 {% if t.is_overdue %}bg-rose-500/10 hover:bg-rose-500/20{% elif t.is_warning %}bg-amber-500/10 hover:bg-amber-500/20{% endif %}"
                data-ticket-row data-href="{% url 'ticket_detail' t.id %}" tabindex="0" role="link" aria-label="Abrir ticket {{ t.code }}">
                <td class="td font-semibold text-indigo-100">
                  <a class="inline-flex items-center gap-1 rounded-full border border-indigo-400/40 bg-indigo-500/15 px-3 py-1 text-sm font-semibold text-indigo-100 transition hover:border-indigo-300 hover:text-white focus-visible:outline-none" href="{% url 'ticket_detail' t.id %}">
                    <i class="bi bi-hash"></i>{{ t.code }}
                  </a>
                </td>
                <td class="td text-slate-200">{{ t.title }}</td>
                <td class="td">
                  <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-semibold {% if t.status == 'OPEN' %}bg-sky-500/15 text-sky-100{% elif t.status == 'IN_PROGRESS' %}bg-amber-500/15 text-amber-100{% elif t.status == 'RESOLVED' %}bg-emerald-500/15 text-emerald-100{% else %}bg-slate-600/30 text-slate-200{% endif %}">
                    <i class="bi bi-circle-fill text-[8px]"></i>{{ t.get_status_display }}
                  </span>
                </td>
                <td class="td text-slate-300">
                  <span class="inline-flex items-center gap-1 text-slate-200">
                    {{ t.get_kind_display }}
                    {% if t.kind == 'INCIDENT' %}<i class="bi bi-lightning-charge-fill text-amber-200"></i>{% endif %}
                  </span>
                </td>
                <td class="td text-slate-300">{{ t.category.name|default:"—" }}</td>
                <td class="td text-slate-300">{{ t.priority.name|default:"—" }}</td>
                <td class="td text-slate-300">{% if t.assigned_to %}{{ t.assigned_to.username }}{% else %}—{% endif %}</td>
                <td class="td">
                  {% if t.remaining_hours %}
                  <span class="inline-flex items-center gap-2 rounded-full bg-amber-500/20 px-3 py-1 text-xs font-semibold text-amber-100"><i class="bi bi-hourglass-split"></i>{{ t.remaining_hours|floatformat:1 }} h</span>
                  {% else %}
                  <span class="text-xs text-slate-400">—</span>
                  {% endif %}
                </td>
                <td class="td text-slate-400">{{ t.created_at|date:'d/m/Y H:i' }}</td>
              </tr>
              {% empty %}
              <tr>
                <td class="td text-center text-sm text-slate-400" colspan="9">Sin resultados en este momento.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </article>
    </div>
  </section>
</section>
{% endblock %}
